# 智能家居设备的包级签名

## 摘要

智能家居设备容易受到基于网络流量的被动推理攻击，即使存在加密机制。在本文中，我们提出PINGPONG，一个可以自动从网络流量中提取设备事件(例如，灯泡打开/关闭)的包级签名的工具。我们评估了PINGPONG在流行的智能家居设备上的应用，包括智能插头、恒温器、摄像头、声控设备和智能电视。我们能够:

(1)自动提取由简单的数据包长度和方向序列组成的未知签名;
(2)利用这些特征检测设备或特定事件，平均召回率达97%以上;
(3)表明该签名在现实网络流量的数亿包中是唯一的;
(4)表明我们的方法也适用于公开的数据集;
(5)展示其在不同环境下的健壮性:由本地和远程智能手机触发的事件，以及由家庭自动化系统触发的事件。

## 1、引言

现代智能家居设备正被广泛使用。它们通常通过家用WiFi无线路由器连接互联网，可以通过智能手机或语音助手进行控制。尽管大多数现代智能家居设备对其网络流量进行加密，但最近的工作表明，智能家居容易受到被动推理攻击[3]、[10]-[13]、[19]、[29]、[44]、[45]。窃听者可以利用智能家居设备产生的网络流量特征来推断设备类型和活动，并最终推断用户行为。然而，现有的被动推理技术有其局限性。大多数只能识别设备类型和是否有设备活动(一个事件)，但不能确定事件或命令[10]-[13]，[29]，[44]，[45]的确切类型。其他的只适用于来自特定供应商[19]的有限数量的设备，或者需要来自其他协议(例如Zigbee/Z-Wave)[3]、[54]和应用程序源代码[54]的更多信息。基于流量分析的推理可以通过流量整形[3]，[10]来阻止。最后，许多此类攻击假设IP流量是从家庭路由器上游嗅探出来的，而本地攻击者嗅探加密的WiFi流量的场景，[10]，[23]受到的关注较少。

在本文中，我们使用了各种各样的智能家居设备，即来自16个流行供应商的19个流行的Wi-Fi和Zigbee设备(其中12个是亚马逊上最流行的智能家居设备)，包括智能插头、灯泡、恒温器、家庭安防系统等。在分析这些设备产生的网络流量时，我们观察到，智能家居设备上的事件通常会导致设备、智能手机和云服务器之间的通信产生包含可预测长度的包对。包对通常包括一个来自设备/电话的请求包(“PING”)和一个返回给设备/电话的应答包(“PONG”)。在大多数情况下，不同的设备类型和事件的包长度是不同的，因此，可以用来推断设备和发生的事件的特定类型。基于这一观察结果，我们能够识别新的包级签名(或简称签名)，这些签名仅包含智能家居设备流量中几个包的长度和方向。在本文中，我们展示了这些签名:

(1)可以自动、系统地提取，而无需事先知道设备的行为;

(2)可用于推断细粒度信息，如事件类型;

(3)对应各种不同的事件(例如，“开关/关闭”和“强度”/“颜色”);并且(4)与之前的方法相比(例如，基于统计和体积的方法)有很多优势。

具体来说，本文做出了以下贡献。

### 1.1新包级别签名方法

我们发现了简单而直观的物联网设备新签名:它们由特定长度的短序列(通常为2-6)数据包组成，例如在设备、智能手机和云之间变化。签字生效:

1)它们检测事件发生的平均回招率超过97%，超过了最先进的技术(见第二部分和V-B)。

2)它们是独特的:我们观察到一个低的假阳性率(FPR)，即每4000万个数据包一个假阳性的网络跟踪数以百万计的数据包(见V-C节)。

3)它们描述了各种各样的设备: (i)我们提取了19个设备中的18个的签名，包括最流行的家庭安全设备，如Ring Alarm家庭安全系统和Arlo Q相机(见章节V-A);(ii)我们从公共数据集[39]中提取21个附加设备的签名，包括更复杂的设备，如语音命令设备、智能电视，甚至冰箱(见V-F节)。

4)它们在各种环境中都表现出色:(i)我们从试验台实验和licly可用数据集中提取签名;(ii)我们以不同的方式触发事件ent，即，使用本地和远程智能手机，并使用一个家庭自动化系统。

5)它们可以从未加密和加密的流量中提取。

6)它们允许快速检测事件，因为它们只依赖于几个包的长度和方向，并且不需要任何统计计算。

### 1.2自动提取包级签名工具

我们提出了PINGPONG，一个方法和软件工具:

(1)自动提取包级签名，而不需要事先了解设备，

(2)检测签名在网络痕迹和真实的网络流量。

对于签名提取，PINGPONG首先通过重复触发需要签名的事件，同时捕获网络流量来生成训练数据。接下来，PINGPONG每个流提取请求-应答包对(“PING-PONG”)，将这些包对聚在一起，并对它们进行后处理，尽可能将它们连接成更长的序列。最后，PINGPONG选择频率接近触发事件数的序列作为最终签名。PINGPONG的签名检测部分利用了包级签名的简单性，并使用简单的状态机实现。PINGPONG的实现和数据集可以在[49]上找到。

### 1.3 小节

本文的其余部分结构如下。第二部分概述了相关工作，并对PINGPONG进行了展望。第三节介绍了威胁模型(包括两个截然不同的对手:WAN嗅探器和Wi-Fi嗅探器)、我们的实验设置以及智能插头中的包级签名示例。第四部分介绍了PINGPONG系统的设计，包括签名的提取和检测。第5节介绍了PINGPONG的评估，使用我们自己的试验台实验，以及一些外部公开的数据集。第6节介绍了对包级签名可能的防御的深入讨论。第七节总结并概述了未来工作的方向。关于讨论和评估结果的进一步细节在技术报告[48]中提供。

## 3 问题的设置

在本节中，我们首先介绍威胁模型。然后，我们提出了智能家居环境和我们所考虑的被动推理攻击。我们还讨论了通过人工分析最简单的设备——智能插头的网络流量所获得的关键见解。我们在智能插头中观察到的分组序列启发了PINGPONG方法来自动提取签名。

### A 威胁模型

在本文中，我们关注的是智能家居设备的网络流量泄露智能家居设备和用户的私人信息。虽然大多数智能家居设备对其通信进行了加密，但信息可能会通过流量元数据泄露，比如这些加密数据包的长度和方向。

我们考虑两种不同类型的对手:WAN嗅探器和Wi-Fi嗅探器。对手在检查流量的有利位置以及对手可获得的信息方面有所不同。WAN嗅探器监视家庭路由器和ISP网络(或超出)[10]-[13]之间通信的网络流量。该对手可以检查所有报文的IP头，但不知道设备的MAC地址，以确定是哪个设备发送了流量。我们假设一个使用NAT的标准家庭网络:所有来自家庭的流量都复用到路由器的IP地址上。这类对手的例子包括情报机构和互联网服务提供商。Wi-Fi嗅探器监视加密的IEEE 802.11流量，[10]，[23]还没有得到广泛的研究。我们假设Wi-Fi嗅探器不知道WPA2密钥，因此只能访问以明文形式发送的信息——MAC地址、包长度和定时信息。由于数据包是加密的，Wi-Fi嗅探器不能访问网络和传输层信息。

对于两个对手，我们假设对手都知道他们希望瞄准和被动监控的智能家居设备的类型。因此，他们可以在另一个同类型的设备上离线训练该系统，提取该设备的签名，并对来自他们所目标的智能家居的流量进行签名检测。我们假设设备加密了它们的通信，因此任何对手都无法访问明文通信。

### B 智能家居环境与实验试验台

**实验测试平台。**图1描述了我们的实验设置，它类似于一个典型的智能家居环境。我们对来自16个不同供应商的19种广泛使用的智能家居设备进行了实验(见表2)。我们试图选择一组功能广泛的设备——从插头到摄像头。它们也被广泛使用:这些设备很受欢迎，它们来自知名供应商。前12(用绿色突出显示)是最受欢迎的在亚马逊[7]:(1)获得了大多数评论各自的设备类型和(2)都有至少3.5星等级都是受欢迎的,高质量的(例如,鸟巢T3007ES和Ecobee3恒温器是两个most-reviewed 4星级别,恒温器)。一些设备通过Wi-Fi(比如Amazon插头)连接到路由器，另一些则通过以太网连接。后者包括martThings、Sengled和Hue集散器，用于向Zigbee/Z-Wave设备中继通信:SmartThings插头、Kwikset门锁、Sengled灯泡和Hue灯泡。

![image-20210618132242763](C:\Users\Aknife\AppData\Roaming\Typora\typora-user-images\image-20210618132242763.png)

图1中的每个智能家居设备都是使用其供应商的官方Android应用程序从智能手机控制的。在图1中，智能手机连接到本地网络，设备也连接到本地网络。

**通信。**智能家居设备事件可能导致三对不同设备之间的通信，如图1所示:(1)智能手机和智能家居设备(Phone-Device);(2)智能家居设备和互联网主机(设备云)，(3)智能手机和互联网主机(电话云)。被动推理攻击背后的思想是，这三条通信路径上的任何一条网络流量都可能包含唯一的流量签名，可以利用这些签名推断事件的发生。

### C 实际案例

作为一个说明性的例子，让我们讨论一下我们对3个智能插头的手工分析:TP-Link插头、D-Link插头和SmartThings插头。手工分析的数据是使用图1中的设置收集的。对于每个设备，我们将其切换为ON，等待大约一分钟，然后将其切换为OFF。这个过程重复了3个ON和3个OFF事件，每个事件间隔1分钟。手动记录每个事件的时间戳。在Wireshark中，通过脚本和手工检查相结合的方式对记录在路由器上的PCAP文件进行分析。

**新观察:包对。**我们识别了每个事件后立即发生的流量流，并观察到在每个ON/OFF事件后会有特定长度和方向的数据包对:相同的数据包对一致地出现在所有相同类型的事件(例如，ON)中，但是不同的事件类型略有不同(ON和OFF)。这些对由一个方向的请求包和一个相反方向的应答包组成。从直观上看，这是有意义的:如果智能家居设备改变状态，需要将该信息发送给(请求)，并由(回复)云服务器确认，以使未连接到家庭网络的设备查询智能家居设备的当前状态。这些交换类似于PINGPONG中来回移动的球，这启发了我们的软件工具的名字。

表3说明了观察到的数据包交换。对于TP-Link插头，我们观察到插头和互联网主机之间交换2个TLS应用数据包，当插头被切换为ON时，数据包长度为556和1293，而当插头被切换为OFF时，数据包长度为557和1294。我们没有在D-Link插头本身的通信中观察到任何模式。然而，对于ON事件，控制智能手机总是向互联网主机发送长度为1117的请求包，并接收长度为613的应答包。对于OFF，这些数据包的长度分别为1118和613。与SmartThings插头类似，我们发现在智能手机与两个不同的互联网主机通信时，请求包的长度对于ON和OFF事件是不同的。因此，这种请求-应答模式可以发生在以下三对中的任何一对的通信中:Phone-Device、Device-Cloud或Phone-Cloud(见图1)

![image-20210618133440794](C:\Users\Aknife\AppData\Roaming\Typora\typora-user-images\image-20210618133440794.png)

**关键的见解**。这一初步分析表明，每一种类型的事件都是通过特定长度的数据包对(或更长序列)的交换来唯一标识的。据我们所知，这种类型的网络签名以前从未被发现过，我们将其称为包级签名。

## 4 PINGPONG模型设置

第III-C节中我们的人工分析得出的关键结论是，独特的包长度序列(对于包对或更长的包序列)通常遵循智能插头上的简单事件(例如，ON和OFF)，并且可能被利用作为签名来推断这些事件。这一观察结果促使我们研究:(1)更多的智能家居设备，以及可能控制它们的智能手机，是否在事件后显示其独特的包级序列，(2)这些签名可以学习和自动提取，以及(3)它们足够独特，以准确检测事件。在这一节中，我们将介绍PINGPONG的设计——一个能够解决上述问题的系统!

PINGPONG收集训练数据，如提取包级签名，并检测出现的签名在一个网络跟踪。PINGPONG有两个部分:(1)训练(第IV-A部分)和(2)检测(第IV-B部分)。图2左边显示了PINGPONG的构建块和流程，右边以TP-Link插头为例。在本节中，我们将后者作为一个运行示例。

### A 训练

训练组件负责为攻击者想要分析和攻击的设备提取包级签名。它由5个步骤组成(参见图2)。

![image-20210618135729146](C:\Users\Aknife\AppData\Roaming\Typora\typora-user-images\image-20210618135729146.png)

**数据收集。**生成签名的第一步是为设备收集训练集。训练集是一个网络跟踪(一个PCAP文件)，它包含由设备和智能手机由于事件产生的网络流量;该跟踪伴随着一个包含事件时间戳集的文本文件。PINGPONG通过提供一个使用Android调试桥(adb)[9]在智能手机屏幕上发出触摸输入的shell脚本，部分自动化了训练集收集。该脚本在充当图1中控制器的笔记本电脑上运行。该脚本经过裁剪，可以发出与将要生成训练集的事件相对应的触摸事件序列。例如，如果一个智能插头的ON和OFF事件需要一个训练集，脚本会在屏幕坐标上发出一个触摸事件，该触摸事件对应于插头官方Android应用程序的用户界面上的相应按钮。由于设备供应商可能会在各自的Android应用程序中为按钮选择任意的位置，而且由于不同设备的特性集不同，脚本必须为给定的设备手动修改。该脚本根据每个特定事件发出对应的触摸序列n次，每次间隔m秒本文报告的结果根据事件类型使用n = 50或n = 100(见第V-A节)。当脚本发出事件时，它还将当前时间戳输出到笔记本电脑上的一个文件中。为了收集一个训练集，我们做以下工作:(1)在路由器的接口上启动tcpdump;(2)启动脚本;(3)在第n个事件发出后终止tcpdump。这给我们留下了一组PCAP文件和事件时间戳，它们构成了我们的原始训练集。

我们的签名生成基于从路由器的本地接口收集到的痕迹，因为它们是提供最全面信息的有利点:它们包括本地流量和互联网流量。

![image-20210618135843842](C:\Users\Aknife\AppData\Roaming\Typora\typora-user-images\image-20210618135843842.png)

![image-20210618135859299](C:\Users\Aknife\AppData\Roaming\Typora\typora-user-images\image-20210618135859299.png)

**跟踪滤波。**接下来，PINGPONG过滤收集到的原始训练集，丢弃与用户的智能家居设备操作无关的流量。所有源IP和目的IP与设备或控制智能手机不匹配的报文将被丢弃。此外，在每个时间戳事件之后，所有不在时间窗t内的包都将被丢弃。我们选择t = 15秒来允许与事件相关的所有网络流量有足够的时间来完成。我们还进行了敏感性研究，证实这是一个保守的选择(见V-G节)。接下来，PINGPONG重新组装过滤跟踪中的所有TCP连接。给定了重新组装的TCP连接集，我们现在将注意力转向携带TCP有效负载的数据包P。对于TLS连接，P被进一步限制为仅是未加密的TLS记录头[41]中标记为“应用数据”的数据包子集。通过只考虑P中的数据包，我们可以确保固有的不可预测的控制数据包(例如TCP ack和TLS密钥协商)不会成为签名的一部分，因为P只包含带有应用层有效负载的数据包。

我们将P中的包形成包对来构造集合P'(见定义IV.1)。这是由以下观察结果引起的:组成包级签名的包的确定性序列通常来自设备、智能手机和一些互联网主机之间的请求-应答交换(见第三- c节)。此外，由于包对是最简单的可能模式，而且由于更长的模式(即包序列-参见定义IV.2)可以从包对中重建，我们在训练集中寻找这些包对。

**包对集群**。在形成一组包对之后，相关的包对(即在一个事件之后始终出现的包对)必须从不相关的包对中分离出来。这种选择还需要考虑到潜在相关的包对可能在长度上有轻微的变化。由于我们事先不知道对中的包长度，所以我们使用了一种无监督学习算法:DBSCAN[22]。

图3(a)说明了TP-Link plug的对集群过程。有50个ON和50个OFF动作，并且必须至少有45个类似的包对(n = 50 = minPts = b50−0.1×50c =45)来组成一个集群。在数据点之间形成两个簇，即频率分别为f: 50和f: 98的数据点。由于这两个集群包含在t期间发生的类似的包对，这就非常有信心地表明包与事件相关。

**创建签名**。鉴于DBSCAN产生的输出，接下来，PINGPONG将所有频率不在[bn−0.1nc, dn + 0.1ne]区间内的簇剔除，以便只将频率与事件数n紧密一致的簇包含在签名中。直观地说，这个步骤是用来处理多话的设备，即那些包含而不生成事件的设备。因此，当n = 50时，50在[bn−0.1nc, dn + 0.1ne] =[45,55]中，而98不在[bn−0.1nc, dn + 0.1ne]中，因此，PINGPONG只选择图3中TP-Link插件示例中频率为50的簇对1作为签名候选。由于这一簇中的一对在t期间恰好发生一次，因此有很高的可信度认为这一对与事件有关。接下来，PINGPONG试图连接簇中的包对，以便重新组合可能的最长包序列(见定义IV.2)，这增加了签名是唯一的可能性。当然，只有当一个设备有多个集群时，才会执行包对连接。这是Arlo相机的情况，但不是TP-Link插头。集群x和集群y中的包对被串联起来，对于x中的每个包对px，在y中存在一个包对py，使得px和py在同一个TCP连接中连续出现。如果在y中比在x中有更多的配对，那么额外的y配对就会被丢弃。结果称为一组包序列(见定义IV.3)，如果可能的话，可以考虑与其他集群进一步连接。

**签名验证**。在最终完成签名之前，我们通过对用于生成签名的原始训练集运行检测算法(参见第IV-B节)来验证。如果PINGPONG最多检测到n个事件，且检测到的事件的时间戳与训练过程中记录的事件的时间戳相匹配，则该签名最终成为有效的包级签名(参见定义IV.5)并存储在签名文件中。如果一个签名检测到的事件多于训练集中的实际事件数(即误报)，那么这个检查就会失败。如果签名中的包序列经常出现在t之外，就会发生这种情况。

**签名文件**。签名文件用于保存报文级签名。图3显示了TP-Link插件签名由序列1中的50个数据包序列实例组成，但是在检测过程中只使用一个实例，因为所有50个实例都是identical。图3(b)显示了Arlo相机的签名文件(在右边)。它是一个对序列1和序列2这两组数据包序列进行排序的列表。序列1由50个分组序列组成，每个分组序列由2个分组对组成。序列2由另外50个分组序列组成，每个分组序列由单个分组对组成。由于序列在每个集合中略有不同，在检测过程中考虑所有独特的变化。

### B 检测

为了进行签名检测，PINGPONG网络跟踪视为数据包流，并将每个数据包呈现给一组状态机。为每个流的签名的每个包序列维护一个状态机，即为**WAN嗅探器**的TCP连接或与该包相关的流相关联的**Wi-Fi嗅探器**的第二层流。如果在建模的包序列中，包匹配下一个包(根据长度和方向)，状态机将前进到它的下一个状态。状态机对与预期下一个包不匹配的包作出不同的响应，这取决于是在第2层还是第3层应用检测。对于2层，这样的数据包被简单地忽略，而对于三层，这样的数据包会导致状态机丢弃当前的部分匹配。当状态机达到其终端状态时，报文序列匹配将被报告到辅助模块。该模块等待签名的每个包序列的匹配，并在最终声明签名匹配之前验证序列间的定时约束。关于检测的详细说明请参见[48]的附录A。

## 6 攻击防御

有几种广泛的方法可以混淆网络流量，以防御分析网络流量元数据的被动推理攻击:

1）包填充将虚拟字节添加到每个包中，以混淆依赖于单个包长度和较小体积的推断技术。数据包可以填充为固定长度(例如，MTU)或随机字节数。

2）流量整形故意延迟数据包，以混淆依赖数据包到达间隔时间和随着时间推移的容量的推断技术。

3）流量注入以与真实事件相似的模式(如长度、到达间隔时间或容量签名等)添加虚拟数据包，从而将真实事件流量隐藏在一群虚假事件中。

上述方法可以以不同的方式实现，也可以组合在一起(例如，在同一个VPN上)。由于我们的签名依赖于单个数据包长度的唯一序列，数据包填充是最自然的防御，因此将在下面深入讨论。我们将关于流量整形和流量注入的讨论推迟到[48]的附录C中。我们首先提供文献中数据包填充的简要概述。然后讨论如何实现包填充来混淆包级签名。最后，我们评估了TP-Link插头的数据包填充效果。